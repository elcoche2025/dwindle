<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dwindle - Event Countdown & Countup</title>
<style>
  :root {
    --bg: #1a1a2e;
    --card-bg: #16213e;
    --text: #e0e0e0;
    --text-muted: #8892a4;
    --border: #2a3a5c;
    --accent: #6c63ff;
    --danger: #ff6b6b;
    --success: #2ed573;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    padding: 20px;
  }

  .container {
    max-width: 800px;
    margin: 0 auto;
  }

  header {
    text-align: center;
    padding: 30px 0 20px;
  }

  header h1 {
    font-size: 2.2rem;
    font-weight: 300;
    letter-spacing: 4px;
    text-transform: uppercase;
    margin-bottom: 6px;
  }

  header p {
    color: var(--text-muted);
    font-size: 0.9rem;
  }

  /* Sync status */
  .sync-status {
    text-align: center;
    margin-bottom: 16px;
    font-size: 0.78rem;
    color: var(--text-muted);
    cursor: pointer;
  }

  .sync-status .dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 6px;
    vertical-align: middle;
  }

  .sync-status .dot.green { background: var(--success); }
  .sync-status .dot.yellow { background: #feca57; }
  .sync-status .dot.red { background: var(--danger); }
  .sync-status .dot.gray { background: var(--text-muted); }

  /* Toolbar */
  .toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 20px;
  }

  .toolbar-group {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .btn {
    padding: 8px 16px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--card-bg);
    color: var(--text);
    cursor: pointer;
    font-size: 0.85rem;
    transition: all 0.2s;
  }

  .btn:hover { border-color: var(--accent); }
  .btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
  .btn.primary:hover { opacity: 0.9; }
  .btn.danger { border-color: var(--danger); color: var(--danger); }
  .btn.danger:hover { background: var(--danger); color: #fff; }
  .btn.small { padding: 4px 10px; font-size: 0.78rem; }

  /* Filter pills */
  .filter-bar {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  .filter-pill {
    padding: 5px 14px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 0.82rem;
    transition: all 0.2s;
  }

  .filter-pill:hover { border-color: var(--text-muted); }
  .filter-pill.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  /* Event cards */
  .events-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .event-card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
    border-left: 4px solid var(--accent);
    position: relative;
    transition: transform 0.2s;
  }

  .event-card:hover { transform: translateX(4px); }

  .event-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 10px;
  }

  .event-name {
    font-size: 1.15rem;
    font-weight: 600;
  }

  .event-category {
    font-size: 0.75rem;
    padding: 2px 10px;
    border-radius: 12px;
    background: rgba(255,255,255,0.08);
    color: var(--text-muted);
    white-space: nowrap;
  }

  .event-date {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-bottom: 14px;
  }

  .event-countdown {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }

  .countdown-unit {
    text-align: center;
  }

  .countdown-value {
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1;
  }

  .countdown-label {
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-top: 4px;
  }

  .event-direction {
    font-size: 0.78rem;
    margin-top: 10px;
    font-style: italic;
    color: var(--text-muted);
  }

  .event-notes {
    font-size: 0.85rem;
    color: var(--text-muted);
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid var(--border);
    white-space: pre-wrap;
  }

  .event-actions {
    position: absolute;
    top: 12px;
    right: 12px;
    display: flex;
    gap: 6px;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .event-card:hover .event-actions { opacity: 1; }

  .action-btn {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    transition: all 0.2s;
  }

  .action-btn:hover { border-color: var(--text); color: var(--text); }
  .action-btn.delete:hover { border-color: var(--danger); color: var(--danger); }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 100;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 30px;
    width: 100%;
    max-width: 460px;
    border: 1px solid var(--border);
    max-height: 90vh;
    overflow-y: auto;
  }

  .modal h2 {
    font-size: 1.3rem;
    font-weight: 500;
    margin-bottom: 20px;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    font-size: 0.82rem;
    color: var(--text-muted);
    margin-bottom: 6px;
  }

  .form-group input, .form-group select, .form-group textarea {
    width: 100%;
    padding: 10px 12px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg);
    color: var(--text);
    font-size: 0.95rem;
  }

  .form-group textarea {
    resize: vertical;
    min-height: 60px;
    font-family: inherit;
  }

  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    outline: none;
    border-color: var(--accent);
  }

  .form-group .hint {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 4px;
  }

  .color-options {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .color-swatch {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.2s;
  }

  .color-swatch:hover { transform: scale(1.15); }
  .color-swatch.selected { border-color: #fff; transform: scale(1.15); }

  .form-actions {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 24px;
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }

  .empty-state h3 {
    font-size: 1.2rem;
    font-weight: 400;
    margin-bottom: 8px;
  }

  /* Sort indicator */
  .sort-select {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--card-bg);
    color: var(--text);
    font-size: 0.85rem;
    cursor: pointer;
  }

  .sort-select:focus { outline: none; border-color: var(--accent); }

  /* Responsive */
  @media (max-width: 500px) {
    .countdown-value { font-size: 1.4rem; }
    .event-countdown { gap: 12px; }
    .event-actions { opacity: 1; }
    header h1 { font-size: 1.6rem; }
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>Dwindle</h1>
    <p>Track your moments &mdash; past and future</p>
  </header>

  <div class="sync-status" id="syncStatus" onclick="openSettingsModal()">
    <span class="dot gray"></span> Click to set up cloud sync
  </div>

  <div class="toolbar">
    <div class="toolbar-group">
      <button class="btn primary" onclick="openModal()">+ New Event</button>
    </div>
    <div class="toolbar-group">
      <select class="sort-select" id="sortSelect" onchange="renderEvents()">
        <option value="date-asc">Date (soonest first)</option>
        <option value="date-desc">Date (furthest first)</option>
        <option value="name-asc">Name (A-Z)</option>
        <option value="created-desc">Recently added</option>
      </select>
      <button class="btn" onclick="exportData()" title="Export data">Export</button>
      <button class="btn" onclick="document.getElementById('importInput').click()" title="Import data">Import</button>
      <input type="file" id="importInput" accept=".json" style="display:none" onchange="importData(event)">
    </div>
  </div>

  <div class="filter-bar" id="filterBar"></div>
  <div class="events-grid" id="eventsGrid"></div>
</div>

<!-- Add/Edit Modal -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalOutside(event)">
  <div class="modal">
    <h2 id="modalTitle">New Event</h2>
    <form onsubmit="saveEvent(event)">
      <input type="hidden" id="editId">
      <div class="form-group">
        <label>Event Name</label>
        <input type="text" id="eventName" required placeholder="e.g., Birthday Party">
      </div>
      <div class="form-group">
        <label>Date</label>
        <input type="date" id="eventDate" required>
      </div>
      <div class="form-group">
        <label>Time (optional)</label>
        <input type="time" id="eventTime">
      </div>
      <div class="form-group">
        <label>Category</label>
        <input type="text" id="eventCategory" placeholder="e.g., Personal, Work, Travel" list="categoryList">
        <datalist id="categoryList"></datalist>
      </div>
      <div class="form-group">
        <label>Notes (optional)</label>
        <textarea id="eventNotes" placeholder="Add any notes about this event..."></textarea>
      </div>
      <div class="form-group">
        <label>Color</label>
        <div class="color-options" id="colorOptions"></div>
      </div>
      <div class="form-actions">
        <button type="button" class="btn" onclick="closeModal()">Cancel</button>
        <button type="submit" class="btn primary">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteOverlay" onclick="closeDeleteOutside(event)">
  <div class="modal" style="max-width:360px; text-align:center;">
    <h2>Delete Event?</h2>
    <p style="color:var(--text-muted); margin-bottom:24px;">This cannot be undone.</p>
    <input type="hidden" id="deleteId">
    <div class="form-actions" style="justify-content:center;">
      <button class="btn" onclick="closeDelete()">Cancel</button>
      <button class="btn danger" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsOverlay" onclick="closeSettingsOutside(event)">
  <div class="modal">
    <h2>Cloud Sync Settings</h2>
    <p style="color:var(--text-muted); margin-bottom:16px; font-size:0.85rem;">
      Your events are automatically saved to a GitHub Gist so they're available on any device. You only need to set this up once.
    </p>
    <div class="form-group">
      <label>GitHub Personal Access Token</label>
      <input type="password" id="settingsToken" placeholder="ghp_...">
      <p class="hint">
        Create one at GitHub &rarr; Settings &rarr; Developer settings &rarr; Personal access tokens &rarr; Tokens (classic). Only the <strong>gist</strong> scope is needed.
      </p>
    </div>
    <div class="form-group" id="gistIdGroup">
      <label>Gist ID (leave blank to create a new one)</label>
      <input type="text" id="settingsGistId" placeholder="Auto-created on first sync">
      <p class="hint">If you already set up Dwindle on another device, paste that Gist ID here to sync.</p>
    </div>
    <div class="form-actions">
      <button type="button" class="btn danger" onclick="clearSyncSettings()" style="margin-right:auto;">Disconnect</button>
      <button type="button" class="btn" onclick="closeSettings()">Cancel</button>
      <button type="button" class="btn primary" onclick="saveSyncSettings()">Save &amp; Sync</button>
    </div>
  </div>
</div>

<script>
  const COLORS = [
    '#6c63ff', '#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3',
    '#54a0ff', '#5f27cd', '#01a3a4', '#f368e0', '#ff6348',
    '#2ed573', '#1e90ff', '#eccc68', '#a29bfe', '#fd79a8'
  ];

  const REPO_OWNER = 'elcoche2025';
  const REPO_NAME = 'dwindle';
  const DATA_FILE = 'data.json';

  let events = [];
  let activeFilter = 'all';
  let selectedColor = COLORS[0];
  let syncTimer = null;
  let fileSha = null;

  // --- Init ---
  async function init() {
    loadEvents();
    renderColorSwatches();
    renderFilterBar();
    renderEvents();
    setInterval(renderCountdowns, 1000);
    updateSyncStatusDisplay();

    // If sync is configured, pull from cloud on load
    if (getToken()) {
      await pullFromCloud();
    }
  }

  // --- Local Storage ---
  function loadEvents() {
    try {
      events = JSON.parse(localStorage.getItem('dwindle_events') || '[]');
    } catch { events = []; }
  }

  function saveEvents() {
    localStorage.setItem('dwindle_events', JSON.stringify(events));
    scheduleSyncToCloud();
  }

  // --- GitHub Gist Sync ---
  function getToken() {
    return localStorage.getItem('dwindle_gh_token') || '';
  }

  function getGistId() {
    return localStorage.getItem('dwindle_gist_id') || '';
  }

  function updateSyncStatusDisplay(msg, color) {
    const el = document.getElementById('syncStatus');
    if (msg) {
      el.innerHTML = `<span class="dot ${color}"></span> ${msg}`;
      return;
    }
    if (getToken() && getGistId()) {
      el.innerHTML = `<span class="dot green"></span> Synced to cloud`;
    } else if (getToken()) {
      el.innerHTML = `<span class="dot yellow"></span> Setting up sync...`;
    } else {
      el.innerHTML = `<span class="dot gray"></span> Click to set up cloud sync`;
    }
  }

  function scheduleSyncToCloud() {
    if (!getToken()) return;
    if (syncTimer) clearTimeout(syncTimer);
    updateSyncStatusDisplay('Saving...', 'yellow');
    syncTimer = setTimeout(() => pushToCloud(), 1500);
  }

  async function pushToCloud() {
    const token = getToken();
    const gistId = getGistId();
    if (!token) return;

    try {
      const data = JSON.stringify(events, null, 2);

      if (gistId) {
        // Update existing gist
        const res = await fetch(`https://api.github.com/gists/${gistId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            files: { [DATA_FILE]: { content: data } }
          })
        });
        if (!res.ok) throw new Error(`GitHub API error: ${res.status}`);
      } else {
        // Create new gist
        const res = await fetch('https://api.github.com/gists', {
          method: 'POST',
          headers: {
            'Authorization': `token ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            description: 'Dwindle - Event Data (auto-synced)',
            public: false,
            files: { [DATA_FILE]: { content: data } }
          })
        });
        if (!res.ok) throw new Error(`GitHub API error: ${res.status}`);
        const result = await res.json();
        localStorage.setItem('dwindle_gist_id', result.id);
      }

      updateSyncStatusDisplay('Synced to cloud', 'green');
    } catch (err) {
      console.error('Sync push failed:', err);
      updateSyncStatusDisplay('Sync error - click to check settings', 'red');
    }
  }

  async function pullFromCloud() {
    const token = getToken();
    const gistId = getGistId();
    if (!token || !gistId) return;

    try {
      updateSyncStatusDisplay('Loading from cloud...', 'yellow');

      const res = await fetch(`https://api.github.com/gists/${gistId}`, {
        headers: { 'Authorization': `token ${token}` }
      });

      if (!res.ok) throw new Error(`GitHub API error: ${res.status}`);

      const gist = await res.json();
      const file = gist.files[DATA_FILE];

      if (file && file.content) {
        const cloudEvents = JSON.parse(file.content);
        if (Array.isArray(cloudEvents)) {
          // Merge: cloud wins for conflicts, keep unique from both sides
          const merged = mergeEvents(events, cloudEvents);
          events = merged;
          localStorage.setItem('dwindle_events', JSON.stringify(events));
          renderFilterBar();
          renderEvents();
        }
      }

      updateSyncStatusDisplay('Synced to cloud', 'green');
    } catch (err) {
      console.error('Sync pull failed:', err);
      updateSyncStatusDisplay('Sync error - click to check settings', 'red');
    }
  }

  function mergeEvents(local, cloud) {
    const map = new Map();
    // Local events first
    local.forEach(e => map.set(e.id, e));
    // Cloud events overwrite (cloud is source of truth for shared items)
    cloud.forEach(e => map.set(e.id, e));
    return [...map.values()];
  }

  // --- Settings Modal ---
  function openSettingsModal() {
    document.getElementById('settingsToken').value = getToken();
    document.getElementById('settingsGistId').value = getGistId();
    document.getElementById('settingsOverlay').classList.add('open');
  }

  function closeSettings() {
    document.getElementById('settingsOverlay').classList.remove('open');
  }

  function closeSettingsOutside(e) {
    if (e.target === e.currentTarget) closeSettings();
  }

  async function saveSyncSettings() {
    const token = document.getElementById('settingsToken').value.trim();
    const gistId = document.getElementById('settingsGistId').value.trim();

    if (!token) {
      alert('Please enter a GitHub Personal Access Token.');
      return;
    }

    localStorage.setItem('dwindle_gh_token', token);
    if (gistId) {
      localStorage.setItem('dwindle_gist_id', gistId);
    }

    closeSettings();
    updateSyncStatusDisplay('Syncing...', 'yellow');

    if (gistId) {
      // Pull existing data then push merged
      await pullFromCloud();
      await pushToCloud();
    } else {
      // First time - create gist with current data
      await pushToCloud();
    }
  }

  function clearSyncSettings() {
    if (!confirm('Disconnect cloud sync? Your local data will be kept.')) return;
    localStorage.removeItem('dwindle_gh_token');
    localStorage.removeItem('dwindle_gist_id');
    closeSettings();
    updateSyncStatusDisplay();
  }

  // --- Color swatches ---
  function renderColorSwatches() {
    const container = document.getElementById('colorOptions');
    container.innerHTML = COLORS.map(c =>
      `<div class="color-swatch ${c === selectedColor ? 'selected' : ''}"
            style="background:${c}" onclick="selectColor('${c}')"></div>`
    ).join('');
  }

  function selectColor(color) {
    selectedColor = color;
    renderColorSwatches();
  }

  // --- Categories & Filters ---
  function getCategories() {
    const cats = new Set();
    events.forEach(e => { if (e.category) cats.add(e.category); });
    return [...cats].sort();
  }

  function renderFilterBar() {
    const cats = getCategories();
    const bar = document.getElementById('filterBar');
    if (cats.length === 0) { bar.innerHTML = ''; return; }

    let html = `<button class="filter-pill ${activeFilter === 'all' ? 'active' : ''}" onclick="setFilter('all')">All</button>`;
    cats.forEach(c => {
      html += `<button class="filter-pill ${activeFilter === c ? 'active' : ''}" onclick="setFilter('${c.replace(/'/g, "\\'")}')">${c}</button>`;
    });
    bar.innerHTML = html;
  }

  function setFilter(f) {
    activeFilter = f;
    renderFilterBar();
    renderEvents();
  }

  function updateCategoryDatalist() {
    const dl = document.getElementById('categoryList');
    dl.innerHTML = getCategories().map(c => `<option value="${c}">`).join('');
  }

  // --- Render events ---
  function getFilteredSortedEvents() {
    let filtered = activeFilter === 'all' ? [...events] : events.filter(e => e.category === activeFilter);
    const sort = document.getElementById('sortSelect').value;
    filtered.sort((a, b) => {
      switch (sort) {
        case 'date-asc': return new Date(a.date) - new Date(b.date);
        case 'date-desc': return new Date(b.date) - new Date(a.date);
        case 'name-asc': return a.name.localeCompare(b.name);
        case 'created-desc': return (b.createdAt || 0) - (a.createdAt || 0);
        default: return 0;
      }
    });
    return filtered;
  }

  function renderEvents() {
    const grid = document.getElementById('eventsGrid');
    const items = getFilteredSortedEvents();

    if (items.length === 0) {
      grid.innerHTML = `<div class="empty-state">
        <h3>${events.length === 0 ? 'No events yet' : 'No events in this category'}</h3>
        <p>${events.length === 0 ? 'Add your first event to start tracking' : 'Try a different filter'}</p>
      </div>`;
      return;
    }

    grid.innerHTML = items.map(ev => {
      const diff = getTimeDiff(ev.date);
      return `<div class="event-card" style="border-left-color:${ev.color || COLORS[0]}" data-id="${ev.id}">
        <div class="event-actions">
          <button class="action-btn" onclick="editEvent('${ev.id}')" title="Edit">&#9998;</button>
          <button class="action-btn delete" onclick="deleteEvent('${ev.id}')" title="Delete">&times;</button>
        </div>
        <div class="event-header">
          <div class="event-name" style="color:${ev.color || COLORS[0]}">${esc(ev.name)}</div>
          ${ev.category ? `<span class="event-category">${esc(ev.category)}</span>` : ''}
        </div>
        <div class="event-date">${formatDate(ev.date)}</div>
        <div class="event-countdown" data-date="${ev.date}">
          ${renderCountdown(diff)}
        </div>
        <div class="event-direction">${diff.isPast ? 'ago' : 'remaining'}</div>
        ${ev.notes ? `<div class="event-notes">${esc(ev.notes)}</div>` : ''}
      </div>`;
    }).join('');
  }

  function getTimeDiff(dateStr) {
    const target = new Date(dateStr);
    const now = new Date();
    let diffMs = target - now;
    const isPast = diffMs < 0;
    diffMs = Math.abs(diffMs);

    const days = Math.floor(diffMs / 86400000);
    const hours = Math.floor((diffMs % 86400000) / 3600000);
    const minutes = Math.floor((diffMs % 3600000) / 60000);
    const seconds = Math.floor((diffMs % 60000) / 1000);

    const years = Math.floor(days / 365);
    const remainingDays = days % 365;
    const months = Math.floor(remainingDays / 30);
    const finalDays = remainingDays % 30;

    return { years, months, days: finalDays, totalDays: days, hours, minutes, seconds, isPast };
  }

  function renderCountdown(d) {
    let units = [];
    if (d.years > 0) units.push(unit(d.years, 'year' + (d.years !== 1 ? 's' : '')));
    if (d.months > 0 || d.years > 0) units.push(unit(d.months, 'month' + (d.months !== 1 ? 's' : '')));
    units.push(unit(d.days, 'day' + (d.days !== 1 ? 's' : '')));
    units.push(unit(d.hours, 'hour' + (d.hours !== 1 ? 's' : '')));
    units.push(unit(d.minutes, 'min' + (d.minutes !== 1 ? 's' : '')));
    units.push(unit(d.seconds, 'sec' + (d.seconds !== 1 ? 's' : '')));
    return units.join('');
  }

  function unit(val, label) {
    return `<div class="countdown-unit"><div class="countdown-value">${val}</div><div class="countdown-label">${label}</div></div>`;
  }

  function renderCountdowns() {
    document.querySelectorAll('.event-countdown').forEach(el => {
      const diff = getTimeDiff(el.dataset.date);
      el.innerHTML = renderCountdown(diff);
      const dirEl = el.nextElementSibling;
      if (dirEl) dirEl.textContent = diff.isPast ? 'ago' : 'remaining';
    });
  }

  function formatDate(dateStr) {
    const d = new Date(dateStr);
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const hasTime = dateStr.includes('T') && !dateStr.endsWith('T00:00');
    if (hasTime) {
      options.hour = 'numeric';
      options.minute = '2-digit';
    }
    return d.toLocaleDateString('en-US', options);
  }

  function esc(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  // --- Modal ---
  function openModal(id) {
    const overlay = document.getElementById('modalOverlay');
    const title = document.getElementById('modalTitle');
    document.getElementById('editId').value = '';
    document.getElementById('eventName').value = '';
    document.getElementById('eventDate').value = '';
    document.getElementById('eventTime').value = '';
    document.getElementById('eventCategory').value = '';
    document.getElementById('eventNotes').value = '';
    selectedColor = COLORS[0];

    if (id) {
      const ev = events.find(e => e.id === id);
      if (ev) {
        title.textContent = 'Edit Event';
        document.getElementById('editId').value = ev.id;
        document.getElementById('eventName').value = ev.name;
        document.getElementById('eventDate').value = ev.date.split('T')[0];
        if (ev.date.includes('T') && !ev.date.endsWith('T00:00')) {
          const timeParts = ev.date.split('T')[1];
          document.getElementById('eventTime').value = timeParts.substring(0, 5);
        }
        document.getElementById('eventCategory').value = ev.category || '';
        document.getElementById('eventNotes').value = ev.notes || '';
        selectedColor = ev.color || COLORS[0];
      }
    } else {
      title.textContent = 'New Event';
    }

    renderColorSwatches();
    updateCategoryDatalist();
    overlay.classList.add('open');
    setTimeout(() => document.getElementById('eventName').focus(), 100);
  }

  function closeModal() {
    document.getElementById('modalOverlay').classList.remove('open');
  }

  function closeModalOutside(e) {
    if (e.target === e.currentTarget) closeModal();
  }

  function saveEvent(e) {
    e.preventDefault();
    const id = document.getElementById('editId').value;
    const name = document.getElementById('eventName').value.trim();
    const date = document.getElementById('eventDate').value;
    const time = document.getElementById('eventTime').value;
    const category = document.getElementById('eventCategory').value.trim();
    const notes = document.getElementById('eventNotes').value.trim();

    const dateStr = time ? `${date}T${time}` : `${date}T00:00`;

    if (id) {
      const ev = events.find(e => e.id === id);
      if (ev) {
        ev.name = name;
        ev.date = dateStr;
        ev.category = category;
        ev.notes = notes;
        ev.color = selectedColor;
      }
    } else {
      events.push({
        id: crypto.randomUUID(),
        name,
        date: dateStr,
        category,
        notes,
        color: selectedColor,
        createdAt: Date.now()
      });
    }

    saveEvents();
    closeModal();
    renderFilterBar();
    renderEvents();
  }

  // --- Edit / Delete ---
  function editEvent(id) {
    openModal(id);
  }

  function deleteEvent(id) {
    document.getElementById('deleteId').value = id;
    document.getElementById('deleteOverlay').classList.add('open');
  }

  function closeDelete() {
    document.getElementById('deleteOverlay').classList.remove('open');
  }

  function closeDeleteOutside(e) {
    if (e.target === e.currentTarget) closeDelete();
  }

  function confirmDelete() {
    const id = document.getElementById('deleteId').value;
    events = events.filter(e => e.id !== id);
    saveEvents();
    closeDelete();
    renderFilterBar();
    renderEvents();
  }

  // --- Export / Import ---
  function exportData() {
    const data = JSON.stringify(events, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `dwindle-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function importData(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
      try {
        const imported = JSON.parse(ev.target.result);
        if (!Array.isArray(imported)) throw new Error('Invalid format');

        const existingIds = new Set(events.map(e => e.id));
        let added = 0;
        imported.forEach(item => {
          if (!item.id) item.id = crypto.randomUUID();
          if (!existingIds.has(item.id)) {
            events.push(item);
            added++;
          }
        });

        saveEvents();
        renderFilterBar();
        renderEvents();
        alert(`Imported ${added} new event${added !== 1 ? 's' : ''}. ${imported.length - added} duplicate${imported.length - added !== 1 ? 's' : ''} skipped.`);
      } catch (err) {
        alert('Error importing file: ' + err.message);
      }
    };
    reader.readAsText(file);
    e.target.value = '';
  }

  // --- Keyboard ---
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      closeModal();
      closeDelete();
      closeSettings();
    }
  });

  // --- Start ---
  init();
</script>

</body>
</html>
